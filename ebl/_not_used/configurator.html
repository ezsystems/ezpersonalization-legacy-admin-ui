<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <!-- <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> -->
    <title>YooChoose Recommendation Engine | Configurator | Step 2</title>
    <meta name="description" content="YooChoose recommendation engine configurator">
    <meta name="author" content="Jurij Burkanov">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/smoothness/jquery-ui.min.css">
    <!--link href='http://fonts.googleapis.com/css?family=Istok+Web:400,700,400italic,700italic&amp;subset=latin,latin-ext' rel='stylesheet' type='text/css'-->
    <link rel="stylesheet" href="css/styles_new.css">
    <!--<script src="js/jquery-1.7.1.min.js"></script>-->
	<!--<script src="js/jquery-1.9.1.js"></script>-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
    <!--<script src="js/jquery-ui.1.8.16.min.js"></script>-->
	<!--<script src="js/jquery-ui-1.10.2.custom.min.js"></script>-->
	<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
	<script src="js/jquery.cookie.js"></script>
    <!--<script src="js/browser_detection.js"></script>-->
    <script src="js/form_submit_trigger.js"></script>
    <script src="js/equalize.js"></script>
    <script src="js/things.js"></script>
    <script src="js/helper.js"></script>
    <script src="ebl2/js/localizations/localizer.js"></script>


  </head>
  <body id="configurator" class="scenario_configuration_steps">
	<header class="clearfix top_head">
      <div class="logo_area s1_5">
        <h1 title="YooChoose. We recommend."><a href="index.html" class="hide"><span>YooChoose. We recommend.</span></a></h1>
      </div>
      <div class="top_bar clearfix">
        <ul class="language_selection clearfix">
          <li class="de" title="Deutsch" lang="de"><a href="#"><span class="hide">Deutsch</span></a></li>
          <li class="en" title="English" lang="en"><a href="#"><span class="hide">English</span></a></li>
          <li class="fr" title="Fran&ccedil;ais" lang="fr"><a href="#"><span class="hide">Fran&ccedil;ais</span></a></li>
        </ul>
        <a href="logout.html" data-translate="index_logout" class="logout">logout</a>
      </div>
      <nav class="wizard_navi_wrapper s4_5">
		<h2 data-translate="scenario_configuration_area">Scenario configuration</h2>
		<ul class="wizard_steps clearfix">
			<li class="settings_tab">
				<a href="settings.html">
					<span data-translate="settings_scenario_configuration">Settings</span>
				</a>
			</li>
			<li class="configurator_tab current">
				<span>
					<span data-translate="settings_placing_models">Step 2: Placing models</span>
				</span>
			</li>
		</ul>
      </nav>
    </header>
    <section>
      <header class="scenario_settings clearfix">
		<div class="s1_5">
			<div class="title header_title_basis">
				<span class="status">Partly available</span>:<br/>
				<span data-translate="configurator_header_title_output">Output:</span>
			</div>
		</div>
		<div class="s2_5">
			<div class="type header_title_values">
				<strong class="name">Landing page</strong> <span class="code">(ID: land_page_13425)</span><br/>
				<span class="output_types">article, image</span>
			</div>
		</div>
		<a class="button with_icon save_state" id="button_save" data-translate="settings_save_and_go_next">Save</a>
      </header>
      <article class="clearfix">
        <div class="models_base s2_5">
          <h3 class="clearfix">
            <span></span> <span data-translate="configurator_models">Models</span>
          </h3>
          <ul class="models_groups">
            <li>
              <h4 data-translate="configurator_collaborative">Collaborative</h4>
              <ul id="collaborative_list" class="list_of_models clearfix">
                <li class="dummymodel model" style="display:none">
                  <div>
                    <h5>Dummy</h5>
                    <p>
                      <span class="model_description">DummyDescription</span> <br>
					  <br>
                    </p>
                    <div class="config">
                    	<a class="configure_model configure_model_new"><span class="img"></span><span class="alt" data-translate="configurator_configure">Configure</span></a>
                    	<div class="info">60 Days / 90 Days</div>
                    </div>
                  </div>
                </li>
              </ul>
            </li>
			<li>
              <h4 data-translate="configurator_popularity">Popularity</h4>
			  <ul id="popularity_list" class="list_of_models clearfix">
              </ul>
			</li>
			<li>
              <h4 data-translate="configurator_other">Other</h4>
			  <ul id="other_list" class="list_of_models clearfix">
              </ul>
			</li>
          </ul>
        </div>
        <div class="storyboards_base s3_5">

          <h3>
            <input type="hidden" id="primary_category_path">
            <span data-translate="configurator_primary_recommendations"  style="float:left">Primary recommendation models</span>
            <span class="edit_category_path img" data-inputId="primary_category_path" style="float:right"></span>
            <span id="primary_category_path_level" style="float:right"></span>
            <span id="primary_category_path_str" style="float:right"></span>
          </h3>
          <div id="stage1" class="ui-stage">
            <ul class="clearfix">
              <li id="li_0_0">
                <div class="empty_model_place">
					<div style="padding: 45px 0;" data-translate="configurator_drag_and_drop">
                	drag and drop<br/>a model here
						</div>
                </div>
              </li>
              <li id="li_0_1">
                <div class="empty_model_place">
					<div style="padding: 45px 0;" data-translate="configurator_drag_and_drop">
                  drag and drop<br/>a model here
					</div>
                </div>
              </li>
              <li id="li_0_2">
                <div class="empty_model_place">
					<div style="padding: 45px 0;" data-translate="configurator_drag_and_drop">
                  drag and drop<br/>a model here
					</div>
                </div>
              </li>
            </ul>
          </div>
          <h3>
            <input type="hidden" id="fallback1_category_path">
            <span data-translate="configurator_fall_back" style="float: left;">Fall-back</span>
          	<span class="edit_category_path img" data-inputId="fallback1_category_path" style="float:right"></span>
            <span id="fallback1_category_path_level" style="float:right"></span>
            <span id="fallback1_category_path_str"  style="float:right"></span>
          </h3>
          <div id="stage2" class="ui-stage">
            <ul class="clearfix">
               <li id="li_1_0">
                <div class="empty_model_place">
					<div style="padding: 45px 0;" data-translate="configurator_drag_and_drop">
                	drag and drop<br/>a model here
					</div>
                </div>
              </li>
              <li id="li_1_1">
                <div class="empty_model_place">
					<div style="padding: 45px 0;" data-translate="configurator_drag_and_drop">
                  drag and drop<br/>a model here
					</div>
                </div>
              </li>
              <li id="li_1_2">
                <div class="empty_model_place">
					<div style="padding: 45px 0;" data-translate="configurator_drag_and_drop">
                  drag and drop<br/>a model here
					</div>
                </div>
              </li>
            </ul>
          </div>
          <h3>
          	<input type="hidden" id="fallback2_category_path">
            <span data-translate="configurator_fall_back_2" style="float: left;">Fall back 2 (if everything else fails)</span>
            <span class="edit_category_path img" data-inputId="fallback2_category_path" style="float:right"></span>
            <span id="fallback2_category_path_level" style="float:right"></span>
            <span id="fallback2_category_path_str"  style="float:right"></span>
          </h3>
          <div id="stage3" class="ui-stage">
            <ul class="clearfix">
              <li id="li_2_0">
                <div class="empty_model_place">
					<div style="padding: 45px 0;" data-translate="configurator_drag_and_drop">
                	drag and drop<br/>a model here
					</div>
                </div>
              </li>
              <li id="li_2_1">
                <div class="empty_model_place">
					<div style="padding: 45px 0;" data-translate="configurator_drag_and_drop">
                  drag and drop<br/>a model here
					</div>
                </div>
              </li>
              <li id="li_2_2">
                <div class="empty_model_place">
					<div style="padding: 45px 0;" data-translate="configurator_drag_and_drop">
                  drag and drop<br/>a model here
						</div>
                </div>
              </li>
            </ul>
          </div>
          
          <h3>
          	<input type="hidden" id="fallback3_category_path">
            <span data-translate="configurator_fall_back_3" style="float: left;">Fall back 3 (if everything else fails)</span>
            <span class="edit_category_path img" data-inputId="fallback3_category_path" style="float:right"></span>
            <span id="fallback3_category_path_level" style="float:right"></span>
            <span id="fallback3_category_path_str"  style="float:right"></span>
          </h3>
          <div id="stage4" class="ui-stage">
            <ul class="clearfix">
              <li id="li_3_0">
                <div class="empty_model_place">
					<div style="padding: 45px 0;" data-translate="configurator_drag_and_drop">
                	drag and drop<br/>a model here
					</div>
                </div>
              </li>
              <li id="li_3_1">
                <div class="empty_model_place">
					<div style="padding: 45px 0;" data-translate="configurator_drag_and_drop">
                  drag and drop<br/>a model here
					</div>
                </div>
              </li>
              <li id="li_3_2">
                <div class="empty_model_place">
					<div style="padding: 45px 0;" data-translate="configurator_drag_and_drop">
                  drag and drop<br/>a model here
						</div>
                </div>
              </li>
            </ul>
          </div>

        </div>
      </article>
    </section>

    <div class="overlay">
      <div class="dialog_body model_settings">
        <a class="destroy_dialog">X</a>
        <h2>
			"<span class="model_name"></span>"
			<span data-translate="configurator_submodel">Model Configuration</span>
		</h2>
        <div class="relevance">
          <label for="relevant_period" data-translate="configurator_relevant">Relevant:</label>
          <input id="relevant_period" type="number" name="relevant_period" min="1" max="999" step="1"/>
          <select id="relevant_period_unit" >
          	<option value="H" data-translate="duration_hours">Hours</option>
          	<option value="D" data-translate="duration_days">Days</option>
          	
          </select>
			<a class="helpBtn" data-helptxt="configuration_help_cb_model"></a>
        </div>
		<h2><span data-translate="configurator_submodel">Model Configuration</span></h2>
        <div class="clearfix">
          <div class="filters_base">
            <form class="filters_group clearfix" action="#" method="get" id="grouping_filters_scenario_land_page_13425">
              <h3>
				<!--<span data-translate="configurator_grouping_submodels">Grouping submodels:</span>-->
				  <div class="submodels_attributes">
				    <label for="submodels_attributes" data-translate="configurator_attributes">Attributes:</label>
				    <select id="submodels_attributes" name="submodels_attributes">
						<option value="" data-translate="configurator_submodel_select_attribute" selected="selected">- Select an attribute -</option>
					</select>
				 </div>
			</h3>
			<div id="nominalSubmodelValues" style="display:none;">
              <ul class="grouping_attributes droptrue clearfix">
              </ul>
              <ul class="groups_base clearfix">
                <li>
                  <h5>Group #<span>1</span> <a class="destroy_group" title="Delete this group">X</a></h5>
                  <ul class="user_created_group droptrue clearfix">
                  </ul>
                </li>
                <li class="always_empty">
                  <a href="#" class="create_one_more_group" data-translate="configurator_add_group">Add group</a>
                </li>
              </ul>
              </div>
			  <div id="numericSubmodelValues" style="display:none;">
			  	  <h4 data-translate="configurator_value_range">Value range</h4>
				  <div id="modelGroups" class="table">
					  <div class="tr ghost">
						  <div class="tc">
							  <label for="" data-translate="configurator_group_from"></label>
							  <input type="text" class="from">
						  </div>
						  <div class="tc">
							  <label for="" data-translate="configurator_group_to"></label>
							  <input type="text" class="to">
						  </div>
						  <div class="tc"><div class="delete_interval"></div></div>
					  </div>
				  </div>
				  <div style="padding: 15px;">
				  		<a class="button with_icon create_new inline" data-translate="configurator_add_group">Add Group</a>
				  </div>
			  </div>
			  <p class="hintSpace"></p>
              <a id="save_submodels" class="save" data-translate="configurator_save_changes">Save changes</a>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div id="CB_model_configuration" class="_overlay">
      <div class="_dialog_body">
        <a class="destroy_dialog">X</a>
        <h2>
			"<span class="model_name"></span>"
			<span data-translate="configurator_submodel">Model Configuration</span>
			<!--<a class="helpBtn" data-helptxt="configuration_help_cb_model"></a>-->
		</h2>
        <div class="content">
	        <form>
	        	<div id="maxItemAge" style="margin-bottom: 20px;">
					<span data-translate="configurator_max_item_age">Maximum item age:</span>
	        		<input name="maxItemAge" type="text" size="10">
		        	<select name="maxItemAgeUnit">
		        		<option value="D" data-translate="duration_days">days</option>
		        		<option value="H" data-translate="duration_hours">hours</option>
		        	</select>
					<a class="helpBtn" data-helptxt="configuration_help_maximum_item_age"></a>
	        	</div>
	        	<div id="cb_attributes" class="table">
	        		<div class="tr">
	        			<div class="tc">
							<span data-translate="configurator_attributes">Attributes</span>
							<a class="helpBtn" data-helptxt="configuration_help_cb_model_attribute"></a>
						</div>

						<div class="tc">
							<span data-translate="configurator_weight">Weight</span>
							<a class="helpBtn" data-helptxt="configuration_help_cb_model_weight"></a>
						</div>
	        		</div>

	        		<div class="tr">
	        			<div class="tc"><select name="attr0"></select></div>
	        			<div class="tc"><div id="slider_attr0" class="attr_slider"></div></div>
	        		</div>
	        		<div class="tr">
	        			<div class="tc"><select name="attr1"></select></div>
	        			<div class="tc"><div id="slider_attr1" class="attr_slider"></div></div>
	        		</div>
	        		<div class="tr">
	        			<div class="tc"><select name="attr2"></select></div>
	        			<div class="tc"><div id="slider_attr2" class="attr_slider"></div></div>
	        		</div>
	        	</div>
	        	<div class="hintSpace">
					<div id="maxItemsAgeMessage"></div>
					<div id="hasNominalMessage"></div>
					<div id="attrCountMessage"></div>
	        	</div>
	        	<a id="save_cbmodel" class="save" data-translate="configurator_save_changes" style="float: right;">Save Changes</a>
				<div style="clear: both;"></div>
	        </form>
        </div>
      </div>
    </div>

	<div id="editorial_model_configurator" class="_overlay">
      <div class="_dialog_body">
        <a class="destroy_dialog">X</a>
        <h2>
			"<span class="model_name"></span>"
			<!--<a class="helpBtn" data-helptxt="configuration_help_cb_model"></a>-->
		</h2>
        <div class="content">
	        <div id="editorial_lists">
				<div id="dummyList" class="editorial_list" style="display: none;">
					<h3>replace name</h3>
					<div class="listHead">
						<span class="idCol" data-translate="editorial_list_item_id">Id</span>
						<span class="titleCol" data-translate="editorial_list_item_title">Title</span>
						<span class="deleteCol" data-translate="editorial_list_delete_item">Delete</span>
					</div>
					<ul class="itemList"></ul>
				</div>
				<div style="clear: both;"></div>
			</div>
			<div class="hintSpace"></div>
			<div>
				<form>
					<label for="itemId" data-translate="editorial_list_form_item_id">Item ID: </label><input id="itemId" type="text" name="itemId" size="10" maxlength="10">
					<label for="itemTypes" data-translate="editorial_list_form_item_type">Item Type: </label><select id="itemTypes" name="itemType"></select>
					<a id="addItem" class="save" data-translate="editorial_list_form_add_item">Add</a>
				</form>
			</div>
			<div>
				<a id="save_editorial_model" class="save" data-translate="editorial_list_save_changes" style="float: right;">Save Changes</a>
				<div style="clear: both;"></div>
			</div>
        </div>
      </div>
    </div>

	<div id="random_model_configuration" class="_overlay">
		<div class="_dialog_body">
			<a class="destroy_dialog">X</a>
			<h2>
				"<span class="model_name"></span>"
				<span data-translate="configurator_submodel">Model Configuration</span>
			</h2>
			<div class="content">
				<form>
					<label id="maxItemAge">
						<span data-translate="configurator_max_item_age">Maximum item age:</span>
						<input name="maxItemAge" type="text" size="10">
						<select name="maxItemAgeUnit">
							<option value="D" data-translate="duration_days">days</option>
							<option value="H" data-translate="duration_hours">hours</option>
						</select><a class="help"></a>
					</label>
					<div class="hintSpace">Space for hints and warnings.</div>
					<a id="save_random_model" class="save" data-translate="configurator_save_changes">Ã„nderungen speichern</a>
				</form>
			</div>
		</div>
	</div>
	
	<div id="category_path_settings" class="_overlay">
		<div class="_dialog_body">
			<a class="destroy_dialog">X</a>
			<h2><span data-translate="configurator_category_path_filtering">Category Path Filtering </span> <a class="help"></a></h2>
			<div class="content">
				<form>
					<div class="left" >
						<input type="radio" value="noFilter" name="category_filter">
					</div>
					<div class="right" data-translate="configurator_recommend_from_whole_shop">
						Always recommend products from the whole shop. Do not use category path for filtering.
					</div>
					<div  class="left">
						<input type="radio" value="sameCategory" name="category_filter">
					</div>
					<div class="right">
						<div data-translate="configurator_recommend_from_same_category">Recommend only products from the same category</div>
						<div>
							<input type="checkbox" id="includeParent" name="includeParent">
							<label for="includeParent" data-translate="configurator_also_include_parent">Also include the parent category and its subcategories</label>
						</div>
						<div>
							<span id="levelsUp"  class="path_slider"></span>
							<span class="levelView"></span> <span data-translate="configurator_levels_up">levels up.</span> 
						</div>
					</div>
					<div  class="left">
						<input type="radio" value="sameMainCategory" name="category_filter">
					</div>
					<div class="right">
						<div data-translate="configurator_recommend_from_same_main_category">Recommend products from the same main category and its subcategories.</div>
						<div>
							<span id="levelsDown" class="path_slider"></span>
							<span class="levelView"></span> <span data-translate="configurator_category_levels">levels down</span> 
						</div>
						
					</div>
					
					<div class="hintSpace" data-translate="configurator_changes_on_category_path">Changes on categorypath configuration only affects models of type Popularity, Random and Stereotypes.</div>
					<a id="save_category_path_settings" class="save" data-translate="configurator_button_ok">OK</a>
				</form>
			</div>
		</div>
	</div>

	<div class="placed_model ghost">
      <a class="destroy_placed_model">X</a>
      <h4 data-translate="configurator_model_name"></h4>
      <form action="#" method="get">
        <ul class="placed_model_settings clearfix">
          <li class="context_options">
            <strong data-translate="configurator_context">Context</strong>
            <label for="placed_model_context_type_website">
              <input type="radio" name="placed_model_context_type" id="placed_model_context_type_website" value="site" checked="checked" />
              <span data-translate="configurator_item">Item</span>
            </label>
			<label for="placed_model_context_type_profile">
			  <input type="radio" name="placed_model_context_type" id="placed_model_context_type_profile" value="profile"/>
			  <span data-translate="configurator_profile">Profile</span>
			</label>
          </li>
		  <li class="usesubmodels">
            <div>
				<input name="use_submodels" id="use_submodels" type="checkbox" value="true" ></input>
				<label for="use_submodels"><span data-translate="configurator_use_submodels">Use submodels:</span></label>
            </div>
          </li>
        </ul>
      </form>
    </div>

	<div class="empty_model_place ghost"><div style="padding: 60px 0;" data-translate="configurator_drag_and_drop">drag and drop<br/>a model here</div></div>
    <div class="message" style="display:none; z-index:1000000;">
      <p>
        <a class="destroy_message">X</a>
        <span id="message_text">Something neutral happened. That's it.</span>
        <a class="close">OK</a>
      </p>
    </div>
	<div id="hoverView" style="display: none;"></div>
	<div id="helpView" style="display: none;">
		<div class="close">x</div>
		<div class="content"></div>
	</div>
  </body>
  <script>
  var reference_code = gup('reference_code');
  var customerID = gup('customer_id');
  var saved = gup('saved');
  //console.log(saved);

  $(document).ready(function() {

	  $('.settings_tab').find('a').attr('href', 'settings.html?reference_code=' + reference_code + '&customer_id=' + customerID);


	  setLoadingDiv($('.models_groups'));

	  setLoadingDiv($('.title'));
	  setLoadingDiv($('.type'));
	  setLoadingDiv($('.storyboards_base'));

	  //ajax request for the models on the left side
	  $.ajax({
		  dataType: "json",
		  beforeSend: function(req) {
			  req.setRequestHeader('no-realm', 'realm1');
		  },
		  statusCode: {
			  401: function(jqXHR, textStatus, errorThrown) {
				  $.cookie('password', null);
				  $.cookie('email', null);
				  window.location = "login.html";
			  }
		  },
		  url: "ebl/v3/" + customerID + "/structure/get_model_list",
		  success: function(json) {

			  $('.models_base').children('h3').children('span').first().text(json.modelList.length);

			  var modelRefList = new Object();
			  var modelRefArray = new Array();
			  if(json.modelList.length > 0) {

				  for(var i = 0; i < json.modelList.length; i ++) {
					  var nest,
							  type,
							  str,
							  ghostModel,
							  maxRating,
							  maxItemAge,
							  model = json.modelList[i];
					  var dummy = $('.dummymodel');
					  var dummyClone = $(dummy).clone();
					  $(dummyClone).show();
					  $(dummyClone).attr("id", "model_" + model.referenceCode);

					  if(model.modelType == "CF_I2I" || model.modelType == "CF_I2I_MIX") {
						  nest = $('#collaborative_list');
					  }
					  else if(model.modelType === "POPULARITY_SHORT" || model.modelType === "POPULARITY_LONG") {
						  nest = $('#popularity_list');
					  }
					  else {
						  nest = $('#other_list');
					  }
					  $(dummyClone).appendTo(nest).removeClass("dummymodel");
					  ghostModel = $('#model_' + model.referenceCode)
							  .removeAttr("style");
					  var additionalModelName = 'model_' + model.modelType;
					  if(model.keyEventType != null) {
						  additionalModelName = additionalModelName + '_' + model.keyEventType;
					  }
					  if(model.valueEventType != null) {
						  additionalModelName = additionalModelName + '_' + model.valueEventType;
					  }
					  if(model.modelType === 'EDITOR_BASED') {
						  additionalModelName = additionalModelName + '_' + (model.referenceCode === 'editor_blacklist' ? 'editor_blacklist' : 'editorial_list');
					  }

					  var refModel = new Object();
					  refModel.referenceCode = model.referenceCode;
					  refModel.additionalModelName = additionalModelName;
					  refModel.submodelsSupported = model.submodelsSupported;
					  refModel.websiteContextSupported = model.websiteContextSupported;
					  refModel.profileContextSupported = model.profileContextSupported;
					  refModel.itemTypeTrees = model.itemTypeTrees;
					  refModel.maximumRatingAge = model.maximumRatingAge;
					  refModel.size = model.size;
				 

					  modelRefArray[i] = refModel;

					  ghostModel.children("div").children("h5").attr('data-translate', additionalModelName + '_title');
					  ghostModel.children("div").children("p").children("span").attr('data-translate', additionalModelName + '_description');
					  //handing the current model to a self executing anonymous function which returns the actual callback function.
					  //this is necessary, because we are in a loop and have to stay in the right context
					  ghostModel.find('a.configure_model').on('click', function(model) {
						  return function(e) {
							  e.preventDefault;
							  var str = $(this).closest('li.model').find('h5').html();
							  if(startsWith('CB', model.modelType, true)) {
								  activateCBModelDialog(model, str);
								  return;
							  } else if(startsWith('random', model.modelType, true)) {
								  activateRandomModelDialog(model, str);
								  return;
							  } else if(startsWith('EDITOR_BASED', model.modelType, true)) {
								  app.gui.showEditorialListEditor(model, str);
								  return;
							  }
							  activateSubmodelDialog(model.referenceCode, str);
						  };
					  }(model));
					  if(! model.submodelsSupported
							  && ! startsWith('CB', model.modelType, true)
							  && ! startsWith('random', model.modelType, true)
							  && ! startsWith('EDITOR_BASED', model.modelType, true)) {
						  ghostModel.find('a.configure_model').hide();
					  }
					  updateModelInfo(ghostModel, model);

				  }
			  }

			  modelRefList.modelRefArray = modelRefArray;
			  $('body').data('model_list', modelRefList);
			  loadRightSection();

			  $('body').on('mouseover', '.model', function() {
				  setLiveDragDrop($(this));
			  });
			  //live was deprecated for a long time and removed in jQuery 1.9
			  //$('.model').live('mouseover',function(){
			  //	setLiveDragDrop($(this));
			  //});

			  unsetLoadingDiv($('.models_groups'));
			  localizer();
		  },
		  error: stdAjaxErrorHandler
	  })
			  .then(function() {
				  $(".models_groups").equalize({
					  eqItems: ".model",
					  exclItems: '.dummymodel',
					  segmentSize: 2,
					  applicantSelector: "> div"
				  });
			  });

	  if(saved == "true") {
		  setMessagePopUp("positive", "message_data_saved_successfully");
	  }

	  $("#button_save").click(function() {

		  setLoadingDiv($('#button_save'));
		  var json = $('body').data('scenario');

		  //the stage categorypath can not be triggered and write in the json object on change
		  //it has to be set in the save method
		   var stages = json.scenario.stages;
		  if(stages[0] != null) {
			  if($('#primary_category_path').val() == "null") {
				  stages[0].useCategoryPath = null;
			  }
			  else {
				  stages[0].useCategoryPath = $('#primary_category_path').val();
			  }
		  }
		 
		  for( var k = 1; k < 4; k ++){
			  if(stages[k] != null) {
				  var strn = '#fallback'+k+'_category_path';
				  if($(strn).val() == "null") {
					  stages[k].useCategoryPath = null;
				  }
				  else {
					  stages[k].useCategoryPath = $(strn).val();
				  }
			  }
		  }
		 
		 
		  
		  //clear the xingModel arrays (remove undefined elements
		  var j;
		  for( var i = 3 ; i > -1; i --){
			  if(! stages[i]) {
				  continue;
			  }
			  j = stages[i].xingModels.length;
			  while(j --) {
				  if(stages[i].xingModels[j]) {
					  continue;
				  }
				  stages[i].xingModels.splice(j, 1);
			  }
		  }

		  $.ajax({
			  type: "POST",
			  beforeSend: function(x) {
				  if(x && x.overrideMimeType) {
					  x.overrideMimeType("application/json;charset=UTF-8");
				  }
				  x.setRequestHeader('no-realm', 'realm1');
			  },
			  mimeType: "application/json",
			  contentType: "application/json;charset=UTF-8",
			  dataType: "json",
			  data: JSON.stringify(json.scenario),
			  url: "ebl/v3/" + customerID + "/structure/update_scenario/",
			  success: function(json) {
				  window.location = "configurator.html?reference_code=" + reference_code + "&customer_id=" + customerID + "&saved=true";
			  },
			  error: stdAjaxErrorHandler
		  });

	  });

	  $('body')
			  .on("change", '.placed_model input', function() {
				  if($(this).attr("type") === "radiobutton") {
					  $('input[name="' + $(this).attr("name") + '"]').removeAttr("checked");
					  $(this).attr("checked", "checked");
				  }
				  var model = $(this).parents('.placed_model').attr('id');
				  console.log(model);
				  updateJsonValueForModel(model);

			  });
	  initHelpBtn();
  });

  //ajax request for the right section

  function loadRightSection() {
	  $.ajax({
		  dataType: "json",
		  beforeSend: function(req) {
			  req.setRequestHeader('no-realm', 'realm1');
		  },
		  url: "ebl/v3/" + customerID + "/structure/get_scenario/" + reference_code,
		  success: function(json) {

			  $('body').data('scenario', json);

			  var modelRefList = $('body').data('model_list');

			  var outputItemTypes = "",
					  outputType;
			  if(json.scenario.outputItemTypes.length > 0) {

				  for(var i = 0; i < json.scenario.outputItemTypes.length; i ++) {
					  outputType = json.scenario.outputItemTypes[i];
					  if(outputItemTypes == "") {
						  switch(outputType) {
							  case 1:
								  outputItemTypes = '<span data-translate="settings_product"></span>';
								  break;
							  case 2:
								  outputItemTypes = '<span data-translate="settings_article"></span>';
								  break;
							  case 3:
								  outputItemTypes = '<span data-translate="settings_image"></span>';
								  break;
							  case 4:
								  outputItemTypes = '<span data-translate="settings_media"></span>';
								  break;
							  case 5:
								  outputItemTypes = '<span data-translate="settings_user_generated_content"></span>';
								  break;
						  }
					  }
					  else {
						  switch(outputType) {
							  case 1:
								  outputItemTypes = outputItemTypes = outputItemTypes + ", " + '<span data-translate="settings_product"></span>';
								  break;
							  case 2:
								  outputItemTypes = outputItemTypes = outputItemTypes + ", " + '<span data-translate="settings_article"></span>';
								  break;
							  case 3:
								  outputItemTypes = outputItemTypes = outputItemTypes + ", " + '<span data-translate="settings_image"></span>';
								  break;
							  case 4:
								  outputItemTypes = outputItemTypes = outputItemTypes + ", " + '<span data-translate="settings_media"></span>';
								  break;
							  case 5:
								  outputItemTypes = outputItemTypes = outputItemTypes + ", " + '<span data-translate="settings_user_generated_content"></span>';
								  break;
						  }

					  }
				  }
			  }

			  //set the colors of the models on the left side

			  for(var l = 0; l < modelRefList.modelRefArray.length; l ++) {
				  var model = modelRefList.modelRefArray[l];//TODO check for multiple declaration
				  var color = "";
				  if(model.itemTypeTrees.length < 1) {
					  color = "red";
				  }
				  else {
					  var hasSameItemType = true;
					  for(var m = 0; m < model.itemTypeTrees.length; m ++) {
						  var itemTypeTree = model.itemTypeTrees[m];
						  if(itemTypeTree.inputItemType != null && itemTypeTree.inputItemType != json.scenario.inputItemType) {
							  hasSameItemType = false;
						  }
						  else {
							  hasSameItemType = true;
							  if(itemTypeTree.outputItemTypes.length > 0) {
								  var counter = 0;
								  for(var n = 0; n < itemTypeTree.outputItemTypes.length; n ++) {
									  var modelOutputItemType = itemTypeTree.outputItemTypes[n];

									  for(var o = 0; o < json.scenario.outputItemTypes.length; o ++) {
										  var scenarioOutputItemType = json.scenario.outputItemTypes[o];
										  if(modelOutputItemType == scenarioOutputItemType) {
											  counter ++;
										  }
									  }
								  }

								  if(counter == json.scenario.outputItemTypes.length) {
									  color = "green";
									  break;
								  }
								  else if(counter == 0) {
									  if(color != "yellow") {
										  color = "red";
									  }
								  }
								  else {
									  color = "yellow";
								  }
							  }
						  }
					  }
					  if(hasSameItemType == false) {
						  if(color == "red")//TODO what is this statement for?
							  color = "red";
					  }
				  }
				  var $model = $('#model_' + model.referenceCode);
				  if(color == "red") {
					  $model.addClass('problem');
				  }
				  else if(color == "green") {
					  $model.addClass('ready_to_use');
				  }
				  else if(color == "yellow") {
					  $model.addClass('needs_building');
				  }
			  }

			  var referenceCodeServer = json.scenario.referenceCode,
					  $scenarioSettings = $(".scenario_settings");

			  $scenarioSettings.find(".output_types").html(outputItemTypes);

			  if(json.scenario.title == null || json.scenario.title == "") {
				  $scenarioSettings.find(".name").text(referenceCodeServer);
			  }
			  else {
				  $scenarioSettings.find(".name").text(json.scenario.title);
			  }
			  $scenarioSettings.find(".code").text("(ID: " + referenceCodeServer + ")");

			  if(json.scenario.avaliable == "AVAILABLE") {
				  $scenarioSettings.children("div").find(".status").attr("data-translate", "status_available");
				  $scenarioSettings.children("div").find(".status").addClass("ready_to_use");

			  }
			  else if(json.scenario.avaliable == "PARTLY_AVAILABLE") {
				  $scenarioSettings.children("div").find(".status").attr("data-translate", "status_partly_available");
				  $scenarioSettings.children("div").find(".status").addClass("partly_available");
			  }
			  else if(json.scenario.avaliable == "NOT_AVAILABLE") {
				  $scenarioSettings.children("div").find(".status").attr("data-translate", "status_not_available");
				  $scenarioSettings.children("div").find(".status").addClass("problem");
			  }
			  else {
				  $scenarioSettings.children("div").find(".status").attr("data-translate", "status_undefined");
				  $scenarioSettings.children("div").find(".status").addClass("problem");
			  }

			  $('#primary_category_path').val(json.scenario.useCategoryPath);


			  function setCategoryPath(path, value) {
// 						console.log(path);
// 						console.log(value);
// 						console.log(typeof value);
				  $('#' + path).val(value === null ? 'null' : value);
				  if(value === 0) {
					  $('#' + path + '_str').attr('data-translate', 'configurator_category_disabled');
					  $('#' + path + '_level').html('');
				  }
				  else if(value === null) {
					  $('#' + path + '_str').attr('data-translate', 'configurator_category_same_category');
					  $('#' + path + '_level').html('');
				  }
				  else if(value < 0) {
					  $('#' + path + '_str').attr('data-translate', 'configurator_category_parent_category');
					  $('#' + path + '_level').html(value);
				  }
				  else if(value > 0) {
					  $('#' + path + '_str').attr('data-translate', 'configurator_category_main_category');
					  $('#' + path + '_level').html(value);
				  }
				  localizer();
			  }

			  $(document).on('click', '.edit_category_path', function() {
				  //init the configuration
				  var $this = $(this),
						  value = $this.siblings('input').val(),
						  inputId = $this.data('inputid'),
						  $inputs = $('input[name="category_filter"]');
				  value = value === 'null' ? null : value;
// 							console.log(value);
				  function change(event, ui) {
					  $(ui.handle).parent().siblings('.levelView').html(ui.value);
				  }

				  //prepare slider
				  $('#levelsDown').slider({
					  'min': 1,
					  'max': 5,
					  'slide': change,
					  'change': change
// 							'disabled': true
				  })
						  .slider('value', 1);
				  $('#levelsUp').slider({
					  'min': 1,
					  'max': 5,
					  'slide': change,
					  'change': change
// 							'disabled': true
				  })
						  .slider('value', 1);

				  function click() {
					  var $this = $(this);
					  if($this.is(':checked') && $this.val() === 'sameCategory') {
						  console.log('sameCat');
						  $('#includeParent').removeAttr('disabled').prop('checked', true);
						  $('#levelsUp').slider('enable');
					  }
					  else {
						  console.log('not sameCat');
						  $('#includeParent').attr('disabled', 'disabled').prop('checked', false);
						  $('#levelsUp').slider('disable').slider('value', 1);
					  }
					  if($this.is(':checked') && $this.val() === 'sameMainCategory') {
						  console.log('same Main');
						  $('#levelsDown').slider('enable');
					  }
					  else {
						  console.log('Not same Main');
						  $('#levelsDown').slider('disable').slider('value', 1);
					  }
				  }

				  $inputs.off('click').on('click', click);
				  if(value === null) {
					  $inputs.filter('[value="sameCategory"]').prop('checked', true).trigger('click');
					  $('input[name="includeParent"]').prop('checked', false);
				  } else if(parseInt(value, 10) === 0) {
//					  window.test = $inputs;
					  $inputs.filter('[value="noFilter"]').prop('checked', true).trigger('click');
					  $('input[name="includeParent"]').prop('checked', false);
				  } else if(parseInt(value, 10) < 0) {
					  $inputs.filter('[value="sameCategory"]').prop('checked', true).trigger('click');
					  $('input[name="includeParent"]').prop('checked', true);
					  $('#levelsUp')
							  .slider('value', Math.abs(parseInt(value, 10)))
							  .slider('enable');
				  } else if(parseInt(value, 10) > 0) {
					  $inputs.filter('[value="sameMainCategory"]').prop('checked', true).trigger('click');
					  $('input[name="includeParent"]').prop('checked', false);
					  $('#levelsDown')
							  .slider('value', parseInt(value, 10))
							  .slider('enable');
				  }

				  $('#save_category_path_settings')
						  .off('click')
						  .on('click', function() {
							  var filter = $inputs.filter(':checked').val(),
									  value = 0;
// 								console.log(filter);
							  if(filter === 'noFilter') {
								  value = 0;
							  } else if(filter === 'sameCategory') {
								  value = $('#includeParent').is(':checked') ? -1 * $('#levelsUp').slider('value') : null;
							  } else if(filter === 'sameMainCategory') {
								  value = $('#levelsDown').slider('value');
							  }

							  $('#' + inputId).val(value === null ? 'null' : value);
							  setCategoryPath(inputId, value);
							  $('#category_path_settings').hide();
						  });
				  $('#category_path_settings')
						  .show()
						  .find('.destroy_dialog')
						  .off('click')
						  .on('click', function() {
							  $(this).closest('._overlay').hide();
						  });
			  });
				
			  var stages = json.scenario.stages;

			  for(var j = 0; j < 4; j ++) {
				  if(stages[j] != null) {

					  if(j == 0) {
						  setCategoryPath('primary_category_path', json.scenario.stages[j].useCategoryPath);
					  }
					  else  {
						  setCategoryPath('fallback'+j+'_category_path', json.scenario.stages[j].useCategoryPath);
					  }
					  

					  if(json.scenario.stages[j].xingModels.length > 0) {
						  for(var k = 0; k < json.scenario.stages[j].xingModels.length; k ++) {
							  var model = json.scenario.stages[j].xingModels[k];
							  var childnumberdiv = j;
							  var childnumberli = k + 1;
							  var nest = $('.ui-stage:eq(' + childnumberdiv + ')').children("ul").children("li:nth-child(" + childnumberli + ")");
							  var ghostModel = $(".placed_model.ghost");
							  ghostModel = ghostModel.clone().appendTo(nest).removeClass("ghost").fadeIn();
							  //ghostModel = $('.ui-stage:eq('+childnumberdiv+')').children("ul").children("li:nth-child("+childnumberli+")").children(".placed_model");
							  ghostModel.attr("id", j + "_" + k + "_" + model.modelReferenceCode);

							  var modelRefArray = modelRefList.modelRefArray;

							  var modelTitle = "";
							  var modelDescription = "";
							  var submodelsSupported = true;
							  var websiteContextSupported = true;
							  var profileContextSupported = true;
							 
							  var str = '';
							  
							  for(var l = 0; l < modelRefList.modelRefArray.length; l ++) {
								  if(modelRefList.modelRefArray[l].referenceCode == model.modelReferenceCode) {
									  modelTitle = modelRefList.modelRefArray[l].additionalModelName + '_title';
									  var maxRating = modelRefList.modelRefArray[l].maximumRatingAge;
									  if(maxRating != null){
										  maxRating = parseDuration(maxRating);
										  str += ' ('+((maxRating.getHours() < 48) ? (maxRating.getHours()
												  + ' <span data-translate="'
												  + (maxRating.getHours() > 1 ? 'duration_hours'
												  : 'duration_hour') + '">Hours</span>')
												  : (maxRating.getDays()
												  + ' <span data-translate="duration_days">Days</span>'))
												  + ')';
									  }else{
										 str += ' ('+ modelRefList.modelRefArray[l].referenceCode + ')';									  
									  }
									  modelDescription = modelRefList.modelRefArray[l].additionalModelName + '_description';

									  if(model.contextFlag == "PROFILE") {
										  //modelTitle = modelRefList.modelRefArray[l].additionalModelName + '_profile_title';
										  //modelDescription = modelRefList.modelRefArray[l].additionalModelName + '_profile_description';
									  }
									  else {
										  //modelTitle = modelRefList.modelRefArray[l].additionalModelName + '_site_title';
										  //modelDescription = modelRefList.modelRefArray[l].additionalModelName + '_site_description';
									  }

									  //hide the elements, that are not supported.
									  submodelsSupported = modelRefList.modelRefArray[l].submodelsSupported;
									  websiteContextSupported = modelRefList.modelRefArray[l].websiteContextSupported;
									  profileContextSupported = modelRefList.modelRefArray[l].profileContextSupported;
								  }
							  }

							  ghostModel.find("h4").attr('data-translate', modelTitle);
							  ghostModel.find("h4").attr('refCode', str);
							  ghostModel.find("h4").attr('title-translate',modelDescription);
							 // ghostModel.find("p.description").attr('data-translate', modelDescription);

							  if(! submodelsSupported) {
								  ghostModel.find(".usesubmodels").hide();
							  }
							  if(websiteContextSupported == false || profileContextSupported == false) {
								  ghostModel.find(".context_options").hide();
							  }

							  ghostModel.children("form").find('label[for="placed_model_context_type_profile"]').attr("for", "placed_model_context_type_profile" + "_" + j + "_" + k + "_" + model.modelReferenceCode);
							  ghostModel.children("form").find('label[for="placed_model_context_type_website"]').attr("for", "placed_model_context_type_website" + "_" + j + "_" + k + "_" + model.modelReferenceCode);
							  ghostModel.children("form").find('input[id="placed_model_context_type_profile"]').attr("id", "placed_model_context_type_profile" + "_" + j + "_" + k + "_" + model.modelReferenceCode).attr("name", "placed_model_context_type" + "_" + j + "_" + k + "_" + model.modelReferenceCode);
							  ghostModel.children("form").find('input[id="placed_model_context_type_website"]').attr("id", "placed_model_context_type_website" + "_" + j + "_" + k + "_" + model.modelReferenceCode).attr("name", "placed_model_context_type" + "_" + j + "_" + k + "_" + model.modelReferenceCode);
							  ;
							  //ghostModel.children("form").find('input[id="weight_model"]').attr("id", "weight_model"  + "_" + j + "_" + k + "_" + model.modelReferenceCode);
							  //ghostModel.children("form").find('label[for="weight_model"]').attr("for", "weight_model"  + "_" + j + "_" + k + "_" + model.modelReferenceCode);
							  ghostModel.children("form").find('input[id="use_submodels"]').attr("id", "use_submodels" + "_" + j + "_" + k + "_" + model.modelReferenceCode).attr("name", "use_submodels" + "_" + j + "_" + k + "_" + model.modelReferenceCode).val("use_submodels" + "_" + j + "_" + k + "_" + model.modelReferenceCode);
							  ghostModel.children("form").find('label[for="use_submodels"]').attr("for", "use_submodels" + "_" + j + "_" + k + "_" + model.modelReferenceCode);

							  if(model.contextFlag === "PROFILE") {
								  ghostModel.children("form").find('input[id="placed_model_context_type_profile_' + j + "_" + k + "_" + model.modelReferenceCode + '"]').attr("checked", "checked");
							  }
							  else if(model.contextFlag === "ITEM") {
								  ghostModel.children("form").find('input[id="placed_model_context_type_website_' + j + "_" + k + "_" + model.modelReferenceCode + '"]').attr("checked", "checked");
							  }

							  //ghostModel.children("form").find('input[id="weight_model_'+ j + "_" + k + "_" + model.modelReferenceCode+'"]').val(model.weight);
							  if(model.useSubmodels) {
								  ghostModel.children("form").find('input[id="use_submodels_' + j + "_" + k + "_" + model.modelReferenceCode + '"]').attr("checked", "checked");
							  }

							  $('.ui-stage:eq(' + childnumberdiv + ')').children("ul").children("li:nth-child(" + childnumberli + ")").children('.empty_model_place').remove();
						  }
					  }
				  }
			  }
			  localizer();
			  unsetLoadingDiv($('.title'));
			  unsetLoadingDiv($('.type'));
			  unsetLoadingDiv($('.storyboards_base'));
			  setEquals();
		  },
		  error: stdAjaxErrorHandler
	  });

  }

  function loadAttributes(subModels) {
	  window.subModels = {};
	  return $.ajax({
		  dataType: "json",
		  beforeSend: function(req) {
			  req.setRequestHeader('no-realm', 'realm1');
		  },
		  url: "ebl/v3/" + customerID + "/structure/get_attribute_pks",
		  success: function(json) {
			  var list, options, i, l;
			  l = subModels.length;
			  outer:
					  while(l --) {
						  i = json.attributePkList.length;
						  while(i --) {
							  if(subModels[l].attributeKey === json.attributePkList[i].key && subModels[l].submodelType === json.attributePkList[i].type) {
								  continue outer;
							  }
						  }
						  json.attributePkList.push({
							  'key': subModels[l].attributeKey,
							  'type': subModels[l].submodelType
						  });
					  }

			  if(json.attributePkList.length > 0) {
				  list = json.attributePkList;
				  options = '<option value="" data-translate="configurator_submodel_select_attribute" disabled="disabled" selected="selected">- Select an attribute -</option>';
				  for(i = 0; i < list.length; i ++) {
					  l = subModels.length;
					  while(l --) {
						  if(subModels[l].attributeKey === list[i].key &&
								  subModels[l].submodelType === list[i].type) {
							  break;
						  }
					  }
					  window.subModels[list[i].type + list[i].key] = l !== - 1 ? subModels[l] : null;

					  options = options +
							  '<option data-type="' + list[i].type + '"value="' + list[i].key + '">'
							  + (list[i].type === 'NUMERIC' ? '[123] ' : '')
							  + (list[i].type === 'NOMINAL' ? '[ABC] ' : '')
							  + list[i].key + ' ';
					  if(list[i].type === 'NUMERIC' && l !== - 1) {
						  options = options + '(' + subModels[l].intervals.length + ' intervals)';
					  } else if(list[i].type === 'NOMINAL' && l !== - 1) {
						  var count = 0,
								  keys = {},
								  j = subModels[l].attributeValues.length,
								  group;
						  while(j --) {
							  group = subModels[l].attributeValues[j].group;
							  if(keys[group]) {
								  continue;
							  } else {
								  keys[group] = true;
								  count ++;
							  }
						  }
						  options = options + '(' + count + ' groups)';
					  }
					  options = options + '</option>';
				  }
				  $('#submodels_attributes').html(options);
			  }
		  },
		  error: stdAjaxErrorHandler
	  });
  }

  function stdAjaxErrorHandler(jqXHR, textStatus, errorThrown) {
	  if(jqXHR.status != null && jqXHR.status == 403) {
		  setMessagePopUp("problem", "error_server_error_403");
	  }
	  else if(jqXHR.status != null && jqXHR.status == 401) {
		  setMessagePopUp("problem", "error_server_error_401");
	  }
	  else if(jqXHR.status != null && jqXHR.status == 400) {
		  setMessagePopUp("problem", "error_server_error_400");
	  }
	  else if(jqXHR.status != null && jqXHR.status == 404) {
		  setMessagePopUp("problem", "error_server_error_404");
	  }
	  else if(jqXHR.status != null && jqXHR.status == 409) {
		  setMessagePopUp("problem", "error_server_error_409");
	  }
	  else {
		  setMessagePopUp("problem", "error_server_error");
	  }
  }

  function loadDaysField(modelID) {

	  $.ajax({
		  dataType: "json",
		  beforeSend: function(req) {
			  req.setRequestHeader('no-realm', 'realm1');
		  },
		  url: "ebl/v3/" + customerID + "/structure/get_model/" + modelID,
		  success: function(json) {

			  $('body').data('ratingmodel', json);
			  var model = json.model;
			  var days = 0;
			  var maxRating = model.maximumRatingAge ? parseDuration(model.maximumRatingAge) : model.maximumRatingAge;
			  var val = maxRating.D >= 2 ? maxRating.getDays() : maxRating.getHours();
			  var unit = maxRating.D >= 2 ? 'D' : 'H';
			  //console.log(maxRating);
			  $('#relevant_period').val(val);
			  $('#relevant_period_unit').val(unit);
		  },
		  error: stdAjaxErrorHandler
	  });
  }


  function createJsonXingModel(json, stage, stageIndex, modelName, modelIndex) {
	  if(stage == null) {
		  var modelNameWithStage = stageIndex + "_" + modelIndex + "_" + modelName;
		  json.scenario.stages[stageIndex] = new Object();
		  json.scenario.stages[stageIndex].xingModels = new Array();
		  json.scenario.stages[stageIndex].xingModels[0] = new Object();
		  json.scenario.stages[stageIndex].xingModels[0].modelReferenceCode = modelName;

		  var domModel = $("#" + modelNameWithStage);
// 				json.scenario.stages[stageIndex].xingModels[0].weight = domModel.children("form").find('input[id="weight_model_'+modelNameWithStage+'"]').val();
		  if(domModel.children("form").find('input[id="use_submodels_' + modelNameWithStage + '"]').is(':checked')) {
			  json.scenario.stages[stageIndex].xingModels[0].useSubmodels = true;
		  }
		  else {
			  json.scenario.stages[stageIndex].xingModels[0].useSubmodels = false;
		  }

		  var flag = domModel.find('input[name=placed_model_context_type' + '_' + modelNameWithStage + ']:checked').val();

		  if(flag == "profile") {
			  json.scenario.stages[stageIndex].xingModels[0].contextFlag = "PROFILE";
		  }
		  else if(flag == "site") {
			  json.scenario.stages[stageIndex].xingModels[0].contextFlag = "ITEM";
		  }

	  }
	  else {

		  //var newIndex = json.scenario.stages[stageIndex].xingModels.length;
		  json.scenario.stages[stageIndex].xingModels[modelIndex] = new Object();
		  json.scenario.stages[stageIndex].xingModels[modelIndex].modelReferenceCode = modelName;

		  var modelNameWithStage = stageIndex + "_" + modelIndex + "_" + modelName;

		  var domModel = $("#" + modelNameWithStage);
// 					json.scenario.stages[stageIndex].xingModels[newIndex].weight = domModel.children("form").find('input[id="weight_model_'+modelNameWithStage+'"]').val();
		  json.scenario.stages[stageIndex].xingModels[modelIndex].weight = 0;

		  if(domModel.children("form").find('input[id="use_submodels_' + modelNameWithStage + '"]').is(':checked')) {
			  json.scenario.stages[stageIndex].xingModels[modelIndex].useSubmodels = true;
		  }
		  else {
			  json.scenario.stages[stageIndex].xingModels[modelIndex].useSubmodels = false;
		  }

		  var flag = domModel.find('input[name=placed_model_context_type' + '_' + modelNameWithStage + ']:checked').val();

		  if(flag == "profile") {
			  json.scenario.stages[stageIndex].xingModels[modelIndex].contextFlag = "PROFILE";
		  }
		  else if(flag == "site") {
			  json.scenario.stages[stageIndex].xingModels[modelIndex].contextFlag = "ITEM";
		  }
	  }
// 			$('body').data('scenario', json);
	  updateJsonValueForModel(modelName);
  }

  function createJsonModel(modelDOM, modelName) {

	  var json = $('body').data('scenario');

	  var id = modelDOM.parents('div[id^="stage"]').attr('id');
	  var modelIndex = modelDOM.attr("id").substring(2, 3);
	  var stage = "";
	  if(id == "stage1") {
		  stage = json.scenario.stages[0];
		  createJsonXingModel(json, stage, 0, modelName, modelIndex);
	  }
	  else if(id == "stage2") {
		  stage = json.scenario.stages[1];
		  createJsonXingModel(json, stage, 1, modelName, modelIndex);
	  }
	  else if(id == "stage3") {
		  stage = json.scenario.stages[2];
		  createJsonXingModel(json, stage, 2, modelName, modelIndex);
	  }
	  else if(id == "stage4") {
		  stage = json.scenario.stages[3];
		  createJsonXingModel(json, stage, 3, modelName, modelIndex);
	  }
// 		$('body').data('scenario',json); //no need to do that, the object is not serialized with the data() method
  }

  function updateJsonValueForModel(modelName) {
	  var json = $('body').data('scenario');
	  for(var i = 0; i < 4; i ++) {
		  if(json.scenario.stages[i] != null) {
			  for(var j = 0; j < json.scenario.stages[i].xingModels.length; j ++) {
				  var model = json.scenario.stages[i].xingModels[j];
				  if(typeof model != 'undefined') {
					  //the weight is calculated for each model
					  switch(json.scenario.stages[i].xingModels.length) {
						  case 1:
							  model.weight = 100;
							  break;
						  case 2:
							  model.weight = 50;
							  break;
						  case 3:
							  model.weight = j ? 33 : 34;
					  }
					  if((i + "_" + j + "_" + model.modelReferenceCode) == modelName) {

						  var domModel = $("#" + modelName);
// 							model.weight = domModel.children("form").find('input[id="weight_model_'+modelName+'"]').val();

						  if(domModel.children("form").find('input[id="use_submodels_' + modelName + '"]').is(':checked')) {
							  model.useSubmodels = true;
						  }
						  else {
							  model.useSubmodels = false;
						  }
						  var flag = domModel.find('input[name=placed_model_context_type' + '_' + modelName + ']:checked').val();

						  if(flag == "profile") {
							  model.contextFlag = "PROFILE";
						  }
						  else if(flag == "site") {
							  model.contextFlag = "ITEM";
						  }
					  }
				  }
			  }
		  }
	  }
  }

  function deleteJsonModelWithName(modelName) {
	  var json = $('body').data('scenario');
	  for(var i = 0; i < 4; i ++) {
		  if(json.scenario.stages[i] != null) {
			  for(var j = 0; j < json.scenario.stages[i].xingModels.length; j ++) {
				  var model = json.scenario.stages[i].xingModels[j];
				  if(typeof model != 'undefined') {
					  if((i + "_" + j + "_" + model.modelReferenceCode) == modelName) {
						  json.scenario.stages[i].xingModels[j] = undefined;
					  }
				  }
			  }
		  }

	  }
	  updateJsonValueForModel();
  }

  function fillSubModels(modelID) {

	  $.cookie('dialogModelID', modelID);

	  function saveFunc() {
		  if($(this).hasClass('inactive')) {
			  return;
		  }
		  if(window.currentSubModel) {
			  updateSubModel(window.currentSubModel);
		  }
		  saveSubmodels(modelID);
	  }

	  $('#save_submodels')
			  .off('click')
			  .on('click', saveFunc);

	  setLoadingDiv($('.filters_group'));
	  $.ajax({
		  dataType: "json",
		  beforeSend: function(req) {
			  req.setRequestHeader('no-realm', 'realm1');
		  },
		  url: "ebl/v3/" + customerID + "/structure/get_submodel_list/" + modelID
	  })
			  .then(
			  function(json) {
				  //setup the attribute selector
				  loadAttributes(json.submodelList)
						  .then(
						  function() {
							  //init the change handler for the attribute selector
							  $('#submodels_attributes')
									  .off('change')
									  .on('change', function(event) {
										  var $this = $(this),
												  type = $this.find('option:selected').data('type');
										  fillSubModelsChange($this.val(), type, modelID);
									  });
							  if(json.submodelList.length > 0) {
								  $('#submodels_attributes option')
										  .removeAttr('selected')
										  .filter(function() {
											  return ($(this).data('type') === json.submodelList[0].submodelType
													  && $(this).val() === json.submodelList[0].attributeKey)
										  }).attr('selected', 'selected');
								  $('#submodels_attributes').trigger('change');
							  } else {
								  $('.filters_group > div').hide();
								  $('#relevant_period')
										  .off('change')
										  .on('change', function() {
											  var val = checkRelevantPeriod();
											  if(! val) {
												  disableSubmodelActions();
											  } else {
												  enableSubmodelActions();
											  }
										  });
							  }
							  enableSubmodelActions();
							  unsetLoadingDiv($('.filters_group'));
						  }
				  );
			  },
			  function(jqXHR, textStatus, errorThrown) {
				  setMessagePopUp("problem", "error_server_error");
			  }

	  );
  }

  function updateSubModel(model) {
	  if(model.submodelType === 'NUMERIC') {
		  model.intervals = checkNumericSubModel();
	  } else if(model.submodelType === 'NOMINAL') {
		  model.attributeValues = createAttributeValueList();
	  }
  }

  function fillSubModelsChange(attributeKey, type, modelID) {
	  if(! attributeKey) {
		  return;
	  }
	  $.cookie('dialogModelID', modelID);

	  if(window.currentSubModel) {
		  updateSubModel(window.currentSubModel);
	  }

	  window.currentSubModel = window.subModels[type + attributeKey];

	  if(window.subModels && window.subModels[type + attributeKey]) {
		  // we have already an instance
		  if(type === "NUMERIC") {
			  fillNumericSubmodelValues(window.subModels[type + attributeKey]);
		  } else if(type === "NOMINAL") {
			  fillSubmodelValues(window.subModels[type + attributeKey]);
		  }
		  return;
	  }

	  setLoadingDiv($('.filters_group'));
	  $.ajax({
		  dataType: "json",
		  beforeSend: function(req) {
			  req.setRequestHeader('no-realm', 'realm1');
		  },
		  url: "ebl/v3/" + customerID + "/structure/get_submodel/"
				  + encodeURIComponent(modelID) + "/" + encodeURIComponent(type) + "/" + encodeURIComponent(attributeKey),
		  success: function(json) {
			  window.subModels = window.subModels ? window.subModels : {};
			  window.subModels[type + attributeKey] = json.submodel;
			  window.currentSubModel = window.subModels[type + attributeKey];
			  if(type === "NUMERIC") {
				  fillNumericSubmodelValues(json.submodel);
			  } else if(type === "NOMINAL") {
				  fillSubmodelValues(json.submodel);
			  }
			  unsetLoadingDiv($('.filters_group'));

		  },
		  error: function(jqXHR, textStatus, errorThrown) {
			  if(jqXHR.status != null && jqXHR.status == 403) {
				  setMessagePopUp("problem", "error_server_error_403");
			  } else if(jqXHR.status != null && jqXHR.status == 401) {
				  setMessagePopUp("problem", "error_server_error_401");
			  } else if(jqXHR.status != null && jqXHR.status == 400) {
				  setMessagePopUp("problem", "error_server_error_400");
			  } else if(jqXHR.status != null && jqXHR.status == 404) {
				  setMessagePopUp("problem", "error_server_error_404");
			  } else if(jqXHR.status != null && jqXHR.status == 409) {
				  setMessagePopUp("problem", "error_server_error_409");
			  } else {
				  setMessagePopUp("problem", "error_server_error");
			  }
		  }
	  });
  }

  function fillSubmodelValues(subModel) {

	  $('.grouping_attributes').children('li').remove();
	  $('.groups_base').children('li').first().find(
			  "ul.user_created_group").children().remove();
	  $('.groups_base').children('li').slice(1,
					  ($('.groups_base').children('li').length - 1))
			  .remove();

	  $('#relevant_period')
			  .off('change')
			  .on('change', function() {
				  var val = checkRelevantPeriod();
				  if(! val) {
					  disableSubmodelActions();
				  } else {
					  enableSubmodelActions();
				  }
			  });

	  $('#nominalSubmodelValues').show().siblings('div').hide();
	  $('.grouping_attributes').html("");
	  getAttributeValues(subModel.attributeKey, subModel.submodelType)
			  .then(function(json) {
				  //console.log(json);
				  var original;
				  //write all the groups and the according attribute values
				  for(var i = 0; i < subModel.attributeValues.length; i ++) {
					  var attributeValue = subModel.attributeValues[i];
					  if(attributeValue.group === null) {// is handled below
						  $('.grouping_attributes').append(
								  '<li data-value="' + attributeValue.attributeValue + '">' + attributeValue.attributeValue + '</li>');
					  } else {
						  var listStr = '<li data-value="' + attributeValue.attributeValue + '" class="attribute_value">' + attributeValue.attributeValue + ' <a class="remove_attribute_value">x</a></li>';
						  if(attributeValue.group == 1) {
							  original = $('.groups_base').children('li')
									  .children('ul').first();
							  original.append(listStr);
						  } else {
							  var countGroups = $('.groups_base').children('li').length;
							  if(attributeValue.group <= countGroups - 1) {
								  var groupAvailable = $('.groups_base').children(
												  'li').slice(attributeValue.group - 1,
												  attributeValue.group);
								  groupAvailable.children('ul').append(listStr);
							  } else {
								  original = $('.groups_base').children('li')
										  .first();
								  var inlineNumber = parseInt(original.find("h5 > span").text())
										  + (countGroups - 1);
								  $(original).clone().insertBefore(
										  $('.groups_base').children('li').last());
								  $('.groups_base').children('li').last().prev()
										  .find("h5 > span").text(inlineNumber);
								  $('.groups_base').children('li').last().prev()
										  .find("ul.user_created_group > li")
										  .remove();
								  setEquals();
								  setSortable();
								  $('.groups_base')
										  .children('li')
										  .last()
										  .prev()
										  .children('ul')
										  .append(listStr);
							  }
						  }
					  }
				  }
				  //fill the available attribute values, which are not yet in groups
				  var $container = $('.grouping_attributes');
				  console.log(json.attribute.values);
				  var flag;
				  for(i = 0; i < json.attribute.values.length; i ++) {
					  flag = true;
					  for(var l = 0; l < subModel.attributeValues.length; l ++) {
						  //console.log(json.attribute.values[i] + ' =? ' + subModel.attributeValues[l].attributeValue);
						  if(json.attribute.values[i] === subModel.attributeValues[l].attributeValue /*|| subModel.attributeValues[l].group === null*/) {
							  flag = false;
						  }
					  }
					  if(flag) {
						  console.log(json.attribute.values[i]);
						  $container.append('<li data-value="' + json.attribute.values[i] + '">' + json.attribute.values[i] + '</li>');
					  }
				  }
				  setEquals();
			  });
  }

  function getAttributeValues(attributeKey, type) {
	  return $.ajax({
		  'dataType': "json",
		  'beforeSend': function(req) {
			  req.setRequestHeader('no-realm', 'realm1');
		  },
		  'url': "ebl/v3/" + customerID + "/structure/get_attribute_values/"
				  + type + "/" + attributeKey,
		  'error': stdAjaxErrorHandler
	  });
  }

  function disableSubmodelActions() {
	  $('#save_submodels').addClass('inactive');
	  $('#submodels_attributes').attr('disabled', 'disabled');
	  localizer();
  }

  function enableSubmodelActions() {
	  $('#save_submodels').removeClass('inactive');
	  $('.overlay .hintSpace').removeAttr('data-translate').html('');
	  $('#submodels_attributes').removeAttr('disabled');
  }

  function checkRelevantPeriod() {
	  var val = $('#relevant_period').val()
	  if(val.length) {
		  val = parseInt(val, 10);
	  } else {
		  $('.overlay .hintSpace').attr('data-translate',
				  'configurator_message_invalid_relevant_period');
		  return false;
	  }
	  if(isNaN(val) || val < 1) {
		  $('.overlay .hintSpace').attr('data-translate',
				  'configurator_message_invalid_relevant_period');
		  return false
	  }
	  return val;
  }

  function createAttributeValueList() {
	  var attributeValueList = [];
	  var relevantPeriod = checkRelevantPeriod();

	  if(! relevantPeriod) {
		  setMessagePopUp("problem",
				  "configurator_message_invalid_relevant_period");
		  return false;
	  }

	  $('.grouping_attributes').children('li').each(function(index) {
		  var attributeValueObject = new Object();
		  attributeValueObject.group = null;
		  attributeValueObject.attributeValue = $(this).data('value').toString();
		  attributeValueList.push(attributeValueObject);
	  });

	  $('.user_created_group').each(function(index) {
		  var group = parseInt(index + 1);
		  $(this).children('li').each(function(index2) {
			  var attributeValueObject = new Object();
			  attributeValueObject.group = group;
			  attributeValueObject.attributeValue = $(this).data('value').toString();
			  attributeValueList.push(attributeValueObject);
		  });
	  });
	  return attributeValueList;
  }

  function saveSubmodels(e) {
	  //save all the sub models
	  var model, arr = [];
	  for(model in window.subModels) {
		  setLoadingDiv('.filters_group');
		  if(window.subModels[model]) {
			  arr.push(pushSubmodel(window.subModels[model]));//we trigger the save for all submodels
		  }
	  }
	  if(arr.length) {
		  $.when.apply($, arr)//after all sub models have been saved
				  .then(
				  function() {
					  setMessagePopUp("positive", "message_data_saved_successfully");
					  fillSubModels($.cookie('dialogModelID'));
				  },
				  function() {
					  setMessagePopUp('error', 'error_submodel_saving')
				  }
		  );
	  } else {
		  fillSubModels($.cookie('dialogModelID'));
	  }
	  var ratingModel = $('body').data('ratingmodel');
	  var duration = parseDuration();
	  duration[$('#relevant_period_unit').val()] = checkRelevantPeriod();
	  ratingModel.model.maximumRatingAge = duration.getXSDuration();
	  setLoadingDiv($('.overlay .relevance'));
	  pushModel(ratingModel).then(function() {
		  unsetLoadingDiv($('.overlay .relevance'));
	  });
  }

  function fillNumericSubmodelValues(sm) {
	  var $content = $('#numericSubmodelValues'),
			  $ghost = $content.find('.ghost'),
			  $groups = $('#modelGroups'),
			  length,
			  $clone,
			  interval;

	  function modelCheck() {
		  var sub = checkNumericSubModel($content),
				  val = checkRelevantPeriod();
		  if(! val || ! sub) {
			  disableSubmodelActions();
		  } else {
			  enableSubmodelActions();
		  }
	  }

	  $content
			  .off('change')
			  .on('change', '.from, .to', modelCheck)
			  .show()
			  .siblings('div')
			  .hide();
	  $('#relevant_period')
			  .off('change')
			  .on('change', modelCheck);
	  $groups.find('.interval').remove();
	  if(sm && sm.intervals) {
		  //reverse sort the groups
		  sm.intervals
				  .sort(function(a, b) {
					  var aLeft = a.leftValue === null ? Number.NEGATIVE_INFINITY : parseFloat(a.leftValue),
							  aRight = a.rightValue === null ? Number.POSITIVE_INFINITY : parseFloat(a.rightValue),
							  bLeft = b.leftValue === null ? Number.NEGATIVE_INFINITY : parseFloat(b.leftValue),
							  bRight = b.rightValue === null ? Number.POSITIVE_INFINITY : parseFloat(b.rightValue);
					  if(aLeft < bLeft) {
						  return 1;
					  }
					  if(aLeft === bLeft) {
						  if(aRight < bRight) {
							  return 1;
						  }
					  }
					  return - 1;
				  });
		  //go through all the intervals and add them to the modelView
		  length = sm.intervals.length;
		  while(length --) {
			  interval = sm.intervals[length];
			  $clone = $ghost.clone().removeClass('ghost').addClass(
					  'interval');
			  $clone.find('input.from').val(interval.leftValue);
			  $clone.find('input.to').val(interval.rightValue);
			  $groups.append($clone);
		  }
	  }
	  //init the delete group buttons
	  $content.off('click')
			  .on('click', '.delete_interval',function() {
				  $(this).closest('.interval').remove();
				  modelCheck();
			  }).on('click', '.add_group',function() {
				  $groups.append($ghost.clone())
			  }).find('.create_new').off('click')
			  .on('click', function() {
				  $groups.append($ghost.clone().removeClass('ghost')
						  .addClass('interval'));
			  });
  }

  function checkNumericSubModel($content) {
	  //  		console.log('checkNumericSubModel');
	  $content = $content ? $content : $('#numericSubmodelValues');
	  var $groups = $content.find('.interval'), values = [], error = false, val, l, regex = /^$|^[-+]?[0-9]*\.?[0-9]+$/;
	  //console.log($groups);
	  $groups
			  .each(function(index) {
				  if(error)
					  return;
				  var from, to, l, group;
				  from = $.trim($(this).find('.from').val());
				  to = $.trim($(this).find('.to').val());
				  //continue if the group is empty (ignore group)
				  if(! from.length && ! to.length) {
					  return;
				  }
				  console.log(from + ' ' + regex.test(from));
				  if(! regex.test(from) || ! regex.test(to)) {
					  error = 'values_not_numbers';
					  return;
				  }
				  from = from.length ? parseFloat(from)
						  : Number.NEGATIVE_INFINITY;
				  to = to.length ? parseFloat(to)
						  : Number.POSITIVE_INFINITY;
				  //check if the values are numbers
				  if(isNaN(from) || isNaN(to)) {
					  error = 'values_not_numbers';
					  return false;
				  }
				  if(from > to) {
					  error = 'left_bigger_right';
					  return;
				  }

				  l = values.length;
				  while(l --) {
					  group = values[l];
					  if((group.leftValue === from && from === Number.NEGATIVE_INFINITY)
							  || (group.rightValue === to && to === Number.POSITIVE_INFINITY)
							  || (! (from <= group.leftValue && to <= group.leftValue) && ! (from >= group.rightValue && to >= group.rightValue))
							  || (from === group.leftValue && to === group.rightValue)) {
						  error = 'overlapping_intervals';
						  return false;
					  }
				  }
				  values.push({
					  'leftValue': from,
					  'rightValue': to
				  });
			  });
	  if(error) {
		  $('.overlay .hintSpace').attr('data-translate',
				  'configurator_error_' + error);
		  localizer();
		  return false;
	  }
	  $('.overlay .hintSpace').removeAttr('data-translate').html('');

	  l = values.length;
	  while(l --) {
		  val = values[l];
		  val.leftValue = val.leftValue === Number.NEGATIVE_INFINITY ? null : val.leftValue;
		  val.rightValue = val.rightValue === Number.POSITIVE_INFINITY ? null : val.rightValue;
	  }
	  return values;
  }
  /**
   * saves the submodel configuration on the server
   * @param sm
   * @returns jQuery.XHR
   */
  function pushSubmodel(sm) {
	  var submodelRef = $.cookie('dialogModelID');
	  return $.ajax({
		  type: "POST",
		  beforeSend: function(x) {
			  if(x && x.overrideMimeType) {
				  x.overrideMimeType("application/json;charset=UTF-8");
			  }
			  x.setRequestHeader('no-realm', 'realm1');
		  },
		  mimeType: "application/json",
		  contentType: "application/json",
		  dataType: "json",
		  data: JSON.stringify(sm),
		  url: "ebl/v3/" + customerID + "/structure/update_submodel/"
				  + submodelRef,
		  success: function(json) {
			  setMessagePopUp("positive",
					  "message_data_saved_successfully");
		  },
		  error: function(jqXHR, textStatus, errorThrown) {
			  if(jqXHR.status != null && jqXHR.status == 403) {
				  setMessagePopUp("problem", "error_server_error_403");
			  } else if(jqXHR.status != null && jqXHR.status == 401) {
				  setMessagePopUp("problem", "error_server_error_401");
			  } else if(jqXHR.status != null && jqXHR.status == 400) {
				  setMessagePopUp("problem", "error_server_error_400");
			  } else if(jqXHR.status != null && jqXHR.status == 404) {
				  setMessagePopUp("problem", "error_server_error_404");
			  } else if(jqXHR.status != null && jqXHR.status == 409) {
				  setMessagePopUp("problem", "error_server_error_409");
			  } else {
				  setMessagePopUp("problem", "error_server_error");
			  }
		  }
	  });
  }

  /**
   * saves a model on the server
   * @param model
   * @returns {*}
   */
  function pushModel(model) {
	  return $.ajax({
		  type: "POST",
		  beforeSend: function(x) {
			  if(x && x.overrideMimeType) {
				  x.overrideMimeType("application/json;charset=UTF-8");
			  }
			  x.setRequestHeader('no-realm', 'realm1');
		  },
		  mimeType: "application/json",
		  contentType: "application/json;charset=UTF-8",
		  dataType: "json",
		  data: JSON.stringify(model.model),
		  url: "ebl/v3/" + customerID + "/structure/update_model",
		  success: function(json) {
			  updateModelInfo($('#model_' + json.model.referenceCode),
					  json.model);
			  setMessagePopUp("positive",
					  "message_data_saved_successfully");
		  },
		  error: function(jqXHR, textStatus, errorThrown) {
			  if(jqXHR.status != null && jqXHR.status == 403) {
				  setMessagePopUp("problem", "error_server_error_403");
			  } else if(jqXHR.status != null && jqXHR.status == 401) {
				  setMessagePopUp("problem", "error_server_error_401");
			  } else if(jqXHR.status != null && jqXHR.status == 400) {
				  setMessagePopUp("problem", "error_server_error_400");
			  } else if(jqXHR.status != null && jqXHR.status == 404) {
				  setMessagePopUp("problem", "error_server_error_404");
			  } else if(jqXHR.status != null && jqXHR.status == 409) {
				  setMessagePopUp("problem", "error_server_error_409");
			  } else {
				  setMessagePopUp("problem", "error_server_error");
			  }
		  }
	  });
  }
   
   

  /**
   * save a model on the server
   * @param model - Model Object to be saved
   * @param $content - Dom Object where the loading indicator is attached to
   * @return jqXHR
   *
   * @author maik.seyring
   */
  var saveModel = function(model, $content){
  	return $.ajax({
  		type:        "POST",
  		beforeSend:  function (x) {
  			setLoadingDiv($content);
  			if (x && x.overrideMimeType) {
  				x.overrideMimeType("application/json;charset=UTF-8");
  			}
  			x.setRequestHeader('no-realm', 'realm1');
  		},
  		mimeType:    "application/json",
  		contentType: "application/json;charset=UTF-8",
  		dataType:    "json",
  		data:        JSON.stringify(model),
  		url:         "ebl/v3/" + customerID + "/structure/update_model",
  		success:     function (json) {
  			unsetLoadingDiv($content);
  			setMessagePopUp("positive", "message_data_saved_successfully");
  			updateModelInfo($('#model_' + json.model.referenceCode), json.model);
  		},
  		error: defaultErrorHandler
  	});
  };

  function updateModelInfo($model, model) {
	  var type, maxRating, maxItemAge, str;
	  type = model.modelType;
	  maxRating = model.maximumRatingAge ? parseDuration(model.maximumRatingAge)
			  : model.maximumRatingAge;
	  maxItemAge = model.maximumItemAge ? parseDuration(model.maximumItemAge)
			  : model.maximumItemAge;
	  str = '';
	  //Algorithmic Models
	  if(startsWith('CF_I2I', type, true)
			  || startsWith('POPULARITY', type, true)
			  || startsWith('STEREOTYPES', type, true)) {
		  if(maxRating) {
			  str += (maxRating.getHours() < 48) ? maxRating.getHours()
					  + ' <span data-translate="'
					  + (maxRating.getHours() > 1 ? 'duration_hours'
					  : 'duration_hour') + '">Hours</span>'
					  : maxRating.getDays()
					  + ' <span data-translate="duration_days">Days</span>';
		  }
		  if(maxItemAge) {
			  str += ' / ';
			  str += (maxItemAge.getHours() < 48) ? maxItemAge.getHours()
					  + ' <span data-translate="'
					  + (maxRating.getHours() > 1 ? 'duration_hours'
					  : 'duration_hour') + '">Hours</span>'
					  : maxItemAge.getDays()
					  + ' <span data-translate="duration_days">Days</span>';
		  }

	  } else if(startsWith('CB_I2I', type, true)) { //CB Model
		  str += '<span data-translate="configurator_attributes">attributes</span> '
		  var l = model.attributes.length;
		  while(l --) {
			  str += model.attributes[l].key;
			  if(l) {
				  str += ', ';
			  }
		  }
	  } else if(startsWith('EDITOR_BASED', type, true)) { //Editorial List model
		  str += model.size + ' items (' + model.referenceCode + ')';
	  } else if(startsWith('Profile', type, true)) { //Profile Model
		  str += model.listType.toLowerCase();
	  } else if(startsWith('Revenue', type, true)) { //Revenue Model
		  //str += 'Revenue :missing example';
	  } else if(startsWith('Random', type, true)) { //Random Model
		  str += model.maximumItemAge;
	  } else if(startsWith('CBFT', type, true)) { //Random Model
			  str += model.maximumItemAge;
	  } else {
		  str = 'Error: Type Missmatch';
	  }
	  $model.find('.info').html(str);
  }

  /**
   * the app variable holds the wrapper object for all functions to handle the editorial list
   *
   * @author maik.seyring
   */
  var app = {
	  'api': {},
	  'gui': {},
	  'data': {
		  'lists': []
	  },
	  'classes': {},
	  'tools': {},
	  'init': function() {
		  //load the mandator
		  var mandatorName = $.cookie('customerID'); //the cutomerID cookie is used in a wrong way all over the legacy code
		  //TODO: replace the cookie name 'customerID' in index.html and probably in other files too
		  this.data.mandatorName = mandatorName ? mandatorName : null;
	  }
  };

  app.editorialListsEditor = {
	  'init': function() {
		  var self = this;
		  this.$overlay = $('#editorial_model_configurator');
		  this.$editorialLists = $('#editorial_lists');
		  this.$typeSelect = this.$overlay.find('#itemTypes');
		  this.$dummyList = $('#dummyList');
		  //add click handler for the delete buttons of items
		  this.$overlay.on('click', '.deleteItem', function() {
			  $(this).closest('li').remove();
		  });
		  this.$overlay.find('.destroy_dialog').on('click', function() {
			  $(this).closest('._overlay').hide();
		  })
		  this.$overlay.find('#addItem').on('click', function() {
			  var $form = $(this).closest('form'),
					  id = $form.find('#itemId').val(),
					  type = $form.find('#itemTypes').val();
			  if(! id.length) {
				  self.showError('editorial_list_error_empty_id_field');
				  return;
			  }
			  //test if the id contains just digits
			  if(/\D/.test(id)) {
				  //we have non digits in the field
				  self.showError('editorial_list_error_invalid_id');
				  return;
			  }
			  id = parseInt(id, 10);
			  if(id > 2147483647 || id < 0) {
				  self.showError('editorial_list_error_id_out_of_bounds');
				  return
			  }

			  //check if Item already in list
			  var item = self.getItem(type, id);
			  if(item !== null) {
				  self.showError('editorial_list_error_duplicate_item');
				  return;
			  }
			  //load the item from server and add to list
			  app.api.getItem(type, id)
					  .then(function(item) {
						  $form.find('#itemId').val('');
						  self.addItem(item);
						  self.clearError();
					  }
			  );
		  });
		  this.$overlay.find('#save_editorial_model')
				  .on('click', function clickFunc(){
					  var $self = $(this).off('click').addClass('inactive');
					  //self.$overlay.find('.cover').show();
					  app.api.saveEditorialList(self.referenceCode, self.getItems())
						.then(
							function(list){
								$('#model_' + self.referenceCode)
										.find('.info')
										.html(list.length + ' items');
								setMessagePopUp("positive", "message_data_saved_successfully");
							},
							app.tools.stdAjaxErrorHandler
					  	)
						.always(function(){
								  $self.on('click', clickFunc).removeClass('inactive');
								  //self.$overlay.find('.cover').hide();
							  })
				  });
		  //replace the function to make it callable just once
		  this.init = function() {
		  };
	  },
	  'reset': function() {
		  var id;
		  for(id in this.lists) {
			  this.lists[id].remove();
		  }
		  this.lists = {};
		  this.referenceCode = null;
		  this.$typeSelect.children().remove();
		  this.$overlay.find('h2 .model_name').html('');
		  this.clearError();
	  },
	  'prepare': function(types, model) {
		  var id, $option, $listClone;
		  //clean up all the EditorialListEditor
		  this.init();
		  this.reset();//remove all content from prior lists
		  this.referenceCode = model.referenceCode;
		  this.$overlay.find('h2 .model_name')
				  .attr('data-translate', 'editorial_list_title_' + model.referenceCode)
				  .html(model.modelType + ' ' + model.referenceCode);
		  //create the lists for the supported
		  for(id in types) {
			  $option = $('<option></option>');
			  $option.attr('data-translate', 'editorial_list_item_type_' + id)
					  .html(types[id]).val(id);
			  this.$typeSelect.append($option);
			  $listClone = this.$dummyList.clone();
			  $listClone.attr('id', 'type_' + id);
			  $listClone.find('h3').attr('data-translate', 'editorial_list_item_type_'+ id).html(types[id]);
			  $listClone.show();
			  $listClone.find('ul')
					  .sortable({
						  'helper': 'clone',
						  'axis': 'y'
					  });
			  $listClone.appendTo(this.$editorialLists);
			  this.lists[id] = $listClone;
		  }
		  this.$editorialLists.append('<div style="clear: both;"></div>');
		  localizer();
	  },
	  'show': function() {
		  this.$overlay.show();
	  },
	  'hide': function() {
		  this.$overlay.hide();
	  },
	  'addItem': function(item) {
		  var $item;
		  if(this.getItem(item.type, item.id) !== null) {
			  return;
		  }
		  //precede if we have a list for the item
		  if(this.lists[item.type]) {
			  //create a list element
			  $item = $('<li id="item_' + item.type + '_' + item.id + '">' +
					  '<span class="idCol">' + item.id + '</span>' +
					  '<span class="titleCol">' + (item.title === null ? '' : item.title) + '</span>' +
					  '<span class="deleteCol deleteItem">X</span>' +
					  '</li>')
					  .data('item', item);
			  //prepend the list element to the list, new elements are always set on top of the list
			  this.lists[item.type]
					  .find('ul')
					  .prepend($item)
					  .sortable('refresh');
			  //add the event handlers for mouse over tooltips
			  app.tools.toolTipFullContent($item.find('.titleCol'),
				  {
					  'filter': this.etc.titleFilter
			  	});
		  }
	  },
	  'addItems': function(items) {
		  var l = items.length;
		  while(l --) {
			  this.addItem(items[l]);
		  }
	  },
	  'getItem': function(type, id) {
		  return this.$editorialLists
				  .find('#item_' + type + '_' + id)
				  .data('item');
	  },
	  'getItems': function() {
		  var type,
				  $list,
				  items = [];
		  for(type in this.lists) {
			  $list = this.lists[type];
			  $list.find('li').each(function() {
				  var item = $(this).data('item');
				  items.push({
					  'type': item.type,
					  'id': item.id
				  });
			  })
		  }
		  return items;
	  },
	  'showError': function(code) {
		  this.$overlay.find('.hintSpace').attr('data-translate', code);
		  localizer();
	  },
	  'clearError': function() {
		  this.$overlay.find('.hintSpace').html('').removeAttr('data-translate');
	  },
	  'etc': {
		  'titleFilter': function($elem){
			  var tester, w1, w2;
			  $elem = $($elem);
			  tester = $elem.clone()
					  .css({'width': 'auto',
						  'position': 'absolute',
						  'top': 0,
						  'left': '-10000px'} );
			  $('body').append(tester);
			  w1 = tester.width();
			  w2 = $elem.width();
			  tester.remove();
			  return w1 > w2;
		  }
	  }

  };

  /**
   * loads the mandator
   * @param name optional
   * @returns {*}
   * @author maik.seyring
   */
  app.api.getMandator = function(name) {
	  if(app.data.mandator && (name === undefined || app.data.mandator.name === name)) {
		  return $.Deferred().resolve(app.data.mandator).promise();
	  } else {
		  name = name ? name : app.data.mandatorName;
		  return $.ajax({
			  'type': 'GET',
			  'url': 'ebl/v3/profile/get_mandator/' + name,
			  'dataType': 'json'
		  })
				  .then(
				  function(response) {
					  app.data.mandator = response.mandator;
					  return app.data.mandator;
				  },
				  app.tools.stdAjaxErrorHandler
		  );
	  }
  };

  /**
   * loads the editorial list for the given model
   * @param model
   * @returns $.XHR
   */
  app.api.getEditorialList = function(refCode) {
	  return app.api.getMandator() // load the mandator
			  .then(
			  function(mandator) {
				  return $.ajax({
					  'type': 'GET',
					  'url': 'ebl/v4/' + mandator.name + '/elist/get_list/' + refCode,
					  'dataType': 'json'
				  });
			  },
			  app.tools.stdAjaxErrorHandler
	  );
  };

  /**
   * saves the list of items on the server
   * @param list
   * @returns {*}
   */
  app.api.saveEditorialList = function(refCode, list) {
	  return $.ajax({
		  'type': 'POST',
		  'contentType': 'application/json',
		  'url': 'ebl/v4/' + app.data.mandatorName + '/elist/update_list/' + refCode,
		  'data': JSON.stringify(list)
	  });
  };
  /**
   * retrieves a item from server with given Id
   * @param id
   * @returns {*}
   */
  app.api.getItem = function(type, id) {
	  return $.ajax({
		  'type': 'GET',
		  'url': 'ebl/v4/' + app.data.mandatorName + '/elist/get_single_item/' + type + '/' + id
	  })
			  .then(null, app.tools.stdAjaxErrorHandler);
  };

  /**
   * loads the available item types for the mandator
   * @returns {*}
   */
  app.api.getItemTypes = function() {
	  var deferred = $.Deferred();
	  app.api.getMandator()
			  .then(
			  function(mandator) {
				  var itemTypes = {};
				  if(mandator.type === 'SHOP') {
					  itemTypes['1'] = 'Product';

					  if(mandator.version === 'EXTENDED') {
						  itemTypes['2'] = 'Article';
						  itemTypes['3'] = 'Image';
						  itemTypes['4'] = 'Media';
						  itemTypes['5'] = 'User generated';
					  }
				  }
				  if(mandator.type === 'PUBLISHER') {
					  itemTypes['1'] = 'Product';
					  itemTypes['2'] = 'Article';

					  if(mandator.version === 'EXTENDED') {
						  itemTypes['3'] = 'Image';
						  itemTypes['4'] = 'Media';
						  itemTypes['5'] = 'User generated';
					  }
				  }
				  deferred.resolve(itemTypes);
				  return itemTypes;
			  },
			  function() {
				  deferred.reject();
			  }
	  );
	  return deferred.promise();
  };

  app.gui.showEditorialListEditor = function(model) {
	  $.when(app.api.getEditorialList(model.referenceCode), app.api.getItemTypes())
			  .then(
			  function(items, types) {
				  app.editorialListsEditor.prepare(types, model);
				  app.editorialListsEditor.addItems(items[0]);
				  app.editorialListsEditor.show();

			  }
	  )
  };
  (function() {
	  var config = {

	  };
	  app.tools.formValidator = function(conf) {

	  }
  })();

  app.tools.toolTipFullContent = (function() {
	  var $hoverView = $('#hoverView'),
			  _config = {
				  styles: {
					  'padding': '3px',
					  'border': '1px dotted black',
					  'background': '#fbff73',
					  'border-radius': '5px'
				  },
				  timeout: 5000
			  },
			  timer = null,
			  hideHoverView = function(e) {
				  if(timer){
					  clearTimeout(timer);
					  timer = null;
				  }
				  $hoverView
						  .html('')
						  .hide();
			  };

	  return function(elements, config) {
		  var $elements = $(elements);
		  config = $.extend({}, _config, config);
		  $elements.hover(function(e) {
					  if(typeof config.filter === 'function' && ! config.filter(this)) {
						  return;
					  }
					  $hoverView.html($(this).html());
					  $hoverView
							  .css(config.styles)
							  .css({
								  left: e.pageX + 20,
								  top: e.pageY - 20
							  })
							  .show();
					  if(config.timeout){
						 timer = setTimeout(hideHoverView, config.timeout);
					  }
				  },
				  hideHoverView);

	  }
  })();

  app.tools.extend = function(a, b) {
	  var prop;
	  if(! a instanceof Object) {
		  return;
	  }
	  for(prop in b) {
		  if(a.hasOwnProperty(prop)) {
			  continue;
		  } else {
			  a[prop] = b[prop];
		  }
	  }
  }

  app.tools.stdAjaxErrorHandler = function(jqXHR, textStatus, errorThrown) {
	  if(jqXHR.status != null && jqXHR.status == 403) {
		  setMessagePopUp("problem", "error_server_error_403");
	  }
	  else if(jqXHR.status != null && jqXHR.status == 401) {
		  setMessagePopUp("problem", "error_server_error_401");
	  }
	  else if(jqXHR.status != null && jqXHR.status == 400) {
		  setMessagePopUp("problem", "error_server_error_400");
	  }
	  else if(jqXHR.status != null && jqXHR.status == 404) {
		  setMessagePopUp("problem", "error_server_error_404");
	  }
	  else if(jqXHR.status != null && jqXHR.status == 409) {
		  setMessagePopUp("problem", "error_server_error_409");
	  }
	  else {
		  setMessagePopUp("problem", "error_server_error");
	  }
  }

  app.init();

  </script>
</html>