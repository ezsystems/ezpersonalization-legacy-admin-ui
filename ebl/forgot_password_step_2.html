<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <!-- <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> -->
    <title>YooChoose Recommendation Engine | Reset password</title>
    <meta name="description" content="YooChoose recommendation engine configurator">
    <meta name="author" content="Alexander Tsikinovsky">
    <link rel="shortcut icon" href="img/favicon.ico">
	<link rel="apple-touch-icon" href="img/favicon.ico">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="css/reset.css">
    <!--link href='http://fonts.googleapis.com/css?family=Istok+Web:400,700,400italic,700italic&amp;subset=latin,latin-ext' rel='stylesheet' type='text/css'-->
    <link rel="stylesheet" href="css/styles_new.css">
    <script src="js/lib/jquery.js"></script>
    <script src="js/lib/jquery-ui.js"></script>
    <script src="js/lib/jquery.cookie.js"></script>
    <script src="js/lib/jquery.i18n.properties.js"></script>
    
   
    <script src="js/form_submit_trigger.js"></script>
    <script src="js/equalize.js"></script>
    <script src="js/things.js"></script>
    <script src="js/helper.js"></script>
    
    <script src="js/i18n.js" data-i18n-files="login,common"></script>
	<script src="js/piwik.js"></script>
	<script>

	var code = gup('code');
	var username = decodeURIComponent(gup('username'));
	var lang = gup('lang');
	
$(document).ready(function () {
	
    $('a.login').click(function () {
	
			var newPassword = $('#password').val();
			var passwordConfirm = $('#password_confirm').val();

			if (newPassword != passwordConfirm) {
				setMessagePopUp("problem", "reset_password_message_not_same_passwords");
			} else {
				var url = $('form').attr('action');
				$.ajax({
					type: "POST",
					dataType: "json",
					data: {
						username: username,
						code: code
					},
					url: url,
					statusCode: {
						400: function (jqXHR, textStatus, errorThrown) {
							setMessagePopUp("problem", "reset_password_message_invalid_forgotten_password_code");
						},
					},
					success: function (json) {
						
						//The code was correct and the passwort can be changed.
						$.ajax({
								type: "POST",
								beforeSend: function (req) {
									 req.setRequestHeader('Authorization', make_base_auth(username, code));
									 req.setRequestHeader('no-realm', 'realm1');
								},
								mimeType: "application/json",
								contentType: "application/x-www-form-urlencoded",
								dataType: "json",
								data: {
									password: newPassword
								},
								url: "ebl/v3/profile/change_password",
								success: function (json) {
									//on success
									$.cookie('password', newPassword);
									$.cookie('email', username);
									$.cookie('customerID', null);

									setMessagePopUp("positive", "reset_password_message_password_set");
									
									$('#message_text').delay(5000).queue(function() {
										window.location = "index.html";
									});

								},
								error: function (jqXHR, textStatus, errorThrown) {
									 if(jqXHR.status != null && jqXHR.status == 403)
					{
						setMessagePopUp("problem", "error_server_error_403");
					}
					else if(jqXHR.status != null && jqXHR.status == 401)
					{
						setMessagePopUp("problem", "error_server_error_401");
					}
					else if(jqXHR.status != null && jqXHR.status == 404)
					{
						setMessagePopUp("problem", "error_server_error_404");
					}
					else if(jqXHR.status != null && jqXHR.status == 409)
					{
						setMessagePopUp("problem", "error_server_error_409");
					}
					else
					{
						setMessagePopUp("problem", "error_server_error");
					}
								}
							});
					},
					error: function (jqXHR, textStatus, errorThrown) {
						 setMessagePopUp("problem", "error_server_error");
					}
				});
			}
    });
});
</script>
  </head>
  <body id="reset_password">
    <header class="clearfix top_head">
      <div class="logo_area s1_5">
        <h1 class="hide" title="YooChoose. We recommend."><span>YooChoose. We recommend.</span></h1>
      </div>
      <div class="top_bar clearfix">
        <ul class="language_selection clearfix">
           <li class="de" title="Deutsch" lang="de"><a href="#"><span class="hide">Deutsch</span></a></li>
           <li class="en" title="English" lang="en"><a href="#"><span class="hide">English</span></a></li>
           <li class="fr" title="Fran&ccedil;ais" lang="fr"><a href="#"><span class="hide">Fran&ccedil;ais</span></a></li>
        </ul>
      </div>
    </header>
    <section class="login_center normal_form">
      <form action="/ebl/v3/registration/reset_password" method="post">
        <fieldset>
          <h3 data-translate="reset_password_2_reset_your_password">Reset your password</h3>
          <div>
            <label for="password" class="required">
              <span data-translate="reset_password_2_new_password">New password:</span>
            </label>
            <input type="password" name="password" id="password" autofocus="autofocus" />
          </div>
          <div>
            <label for="password_confirm" class="required">
              <span data-translate="reset_password_2_confirm">Confirm:</span>
            </label>
            <input type="password" name="password_confirm" id="password_confirm" />
          </div>
          <div class="actions">
            <a class="login button" data-translate="reset_password_2_save_new_password" style="display: inline-block;" >Save new password</a>
          </div>
        </fieldset>
      </form>
    </section>
    <div class="message" style="display:none;">
      <p>
        <a class="destroy_message">X</a>
        <span id="message_text" data-translate="login_message_password_not_correct">Something neutral happened. That's it.</span>
        <a class="close">OK</a>
      </p>
    </div>
  </body>
</html>